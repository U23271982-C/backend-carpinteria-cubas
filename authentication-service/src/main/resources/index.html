<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear y Actualizar Usuario Cliente</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-6 text-gray-800">Cliente de Usuario</h1>

    <!-- Login Button -->
    <div id="login-container">
        <p class="mb-4 text-gray-600">Inicia sesión para continuar</p>
        <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
            Iniciar Sesión con Google
        </button>
    </div>

    <!-- User Info and Update Form -->
    <div id="user-container" class="hidden">
        <p class="text-gray-700 mb-2">¡Bienvenido!</p>
        <div class="text-left bg-gray-50 p-4 rounded-lg mb-4">
            <p class="text-sm font-mono break-all"><strong class="font-semibold">Firebase UID:</strong> <span id="user-uid"></span></p>
            <p class="text-sm font-mono break-all mt-2"><strong class="font-semibold">Email:</strong> <span id="user-email"></span></p>
        </div>

        <!-- Update Form -->
        <div id="update-form-container" class="mt-6 text-left">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Completa o Actualiza tu Información</h2>
            <div class="space-y-4">
                <div>
                    <label for="full-name" class="block text-sm font-medium text-gray-600">Nombre Completo</label>
                    <input type="text" id="full-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Su nombre completo">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-600">Teléfono</label>
                    <input type="tel" id="phone" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej: +51 987654321">
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-600">Dirección</label>
                    <input type="text" id="address" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Av. Siempre Viva 123">
                </div>
            </div>
            <button id="update-user-btn" class="mt-6 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                Actualizar Información
            </button>
        </div>
    </div>

    <!-- Status Message -->
    <div id="status-message" class="mt-4 text-sm font-medium"></div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    // Import functions from the Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCa9nCTVImXDexo-A0Qh-XKzUyK4eIErMc",
        authDomain: "carpinteriacubas-6bd84.firebaseapp.com",
        projectId: "carpinteriacubas-6bd84",
        storageBucket: "carpinteriacubas-6bd84.firebasestorage.app",
        messagingSenderId: "411158338165",
        appId: "1:411158338165:web:ed98c0d5f9b609a1c1363c",
        measurementId: "G-8PK0KP4N59"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // DOM Elements
    const loginContainer = document.getElementById('login-container');
    const userContainer = document.getElementById('user-container');
    const loginBtn = document.getElementById('login-btn');
    const updateUserBtn = document.getElementById('update-user-btn');
    const userUidElem = document.getElementById('user-uid');
    const userEmailElem = document.getElementById('user-email');
    const statusMessageElem = document.getElementById('status-message');
    const fullNameInput = document.getElementById('full-name');
    const phoneInput = document.getElementById('phone');
    const addressInput = document.getElementById('address');

    let currentUser = null;

    // --- Main Functions ---

    // Function to register the user in the backend (API POST call)
    async function registerUserOnBackend(user) {
        const createUserRequest = {
            firebaseUid: user.uid,
            email: user.email
        };
        const apiUrl = 'http://localhost:8084/user-client';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(createUserRequest)
            });

            // We consider it a success if the user was created (2xx)
            // or if they already existed (409 Conflict is a common response for this).
            if (response.ok) {
                console.log('Usuario creado en el backend.');
                return true;
            } else if (response.status === 409) { // 409 Conflict
                console.log('El usuario ya existe en el backend. Continuando.');
                return true;
            } else {
                const errorText = await response.text();
                console.error('Fallo al registrar usuario en el backend:', errorText);
                updateStatus(`Error al registrar en backend: ${response.statusText}`, 'text-red-600');
                return false;
            }
        } catch (error) {
            console.error('Error de red durante el registro:', error);
            updateStatus('Error de conexión. No se pudo registrar el usuario.', 'text-red-600');
            return false;
        }
    }

    // --- Event Listeners ---

    // 1. Login with Google, then automatically register user on backend
    loginBtn.addEventListener('click', async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            currentUser = result.user;
            updateStatus('Inicio de sesión de Firebase exitoso. Verificando usuario en backend...', 'text-blue-600');

            // Automatically try to register/ensure the user exists on the backend
            const registrationSuccessful = await registerUserOnBackend(currentUser);

            if (registrationSuccessful) {
                // Update UI with user info
                userUidElem.textContent = currentUser.uid;
                userEmailElem.textContent = currentUser.email;

                // Show user info and hide login button
                loginContainer.classList.add('hidden');
                userContainer.classList.remove('hidden');
                updateStatus('Usuario verificado. Ya puedes actualizar tu información.', 'text-green-600');
            }
            // If registration fails, an error message is already shown by the register function.

        } catch (error) {
            console.error("Error durante el inicio de sesión de Firebase:", error);
            updateStatus(`Error de Firebase: ${error.message}`, 'text-red-600');
        }
    });

    // 2. Send updated data to your backend API (PUT Request)
    updateUserBtn.addEventListener('click', async () => {
        if (!currentUser) {
            updateStatus('No hay usuario autenticado.', 'text-red-600');
            return;
        }

        const fullName = fullNameInput.value;
        const phone = phoneInput.value;
        const address = addressInput.value;

        // Basic client-side validation
        if (!fullName.trim()) {
            updateStatus('El nombre completo es obligatorio.', 'text-red-600');
            return;
        }

        const userUpdateRequest = {
            fullName,
            phone,
            address
        };

        const apiUrl = `http://localhost:8084/user-client/${currentUser.uid}`;

        updateStatus('Actualizando información...', 'text-blue-600');

        try {
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userUpdateRequest)
            });

            if (response.ok) {
                const responseData = await response.json();
                console.log('API Response:', responseData);
                updateStatus('¡Usuario actualizado exitosamente!', 'text-green-600');
            } else {
                const errorData = await response.text();
                console.error('API Error Response:', errorData);
                updateStatus(`Error de la API: ${response.status} - ${response.statusText}`, 'text-red-600');
            }
        } catch (error) {
            console.error('Error al conectar con la API:', error);
            updateStatus('Error de conexión. Asegúrate que el backend esté corriendo.', 'text-red-600');
        }
    });

    // --- Utility Functions ---
    function updateStatus(message, colorClass) {
        statusMessageElem.textContent = message;
        statusMessageElem.className = `mt-4 text-sm font-medium ${colorClass}`;
    }
</script>
</body>
</html>

