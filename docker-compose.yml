services:
  db_mysql:
    container_name: db_mysql_container
    image: mysql:8.0
    ports:
      - "${SERVICE_MYSQL_PORT}:${SERVICE_MYSQL_PORT}"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASS_MAIN_DEV}
      MYSQL_DATABASE: ${SERVICE_MYSQL_DATABASE}
      MYSQL_ALLOW_EMPTY_PASSWORD: no
    volumes:
      - ./init/init-mysql.sql:/docker-entrypoint-initdb.d/init-mysql.sql
      - mysql_data:/var/lib/mysql # ← Volumen Nombrado
  db_postgresql:
    container_name: db_postgresql_container
    image: postgres:16
    ports:
      - "${SERVICE_POSTGRESQL_PORT}:${SERVICE_POSTGRESQL_PORT}"
    environment:
      POSTGRES_USER: ${POSTGRESQL_USER_MAIN_DEV}
      POSTGRES_PASSWORD: ${POSTGRESQL_PASS_MAIN_DEV}
    volumes:
      - ./init/init-postgres.sql:/docker-entrypoint-initdb.d/init-postgres.sql
      - postgres_data:/var/lib/postgresql # ← Volumen Nombrado PostgreSQL

  discovery-service:
    container_name: discovery-service-container
    image: discovery-service-image
    build:
      context: .
      dockerfile: descubridor-servicio/Dockerfile
    ports:
      - "${DISCOVERY_SERVICE_PORT}:${DISCOVERY_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${DISCOVERY_SERVICE_PORT}
    depends_on:
      - db_mysql
      - db_postgresql

  employee-service:
    container_name: employee-service-container
    image: employee-service-image
    build:
      context: .
      dockerfile: employee-service/Dockerfile
    ports:
      - "${EMPLOYEE_SERVICE_PORT}:${EMPLOYEE_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${EMPLOYEE_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_EMPLOYEE}
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT}
    depends_on:
      - discovery-service
  inventory-matter-service:
    container_name: inventory-matter-service-container
    image: inventory-matter-service-image
    build:
      context: .
      dockerfile: inventory-matter-service/Dockerfile
    ports:
      - "${INVENTORY_MATTER_SERVICE_PORT}:${INVENTORY_MATTER_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${INVENTORY_MATTER_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_INVENTORY_MATTER}
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT}
    depends_on:
     - discovery-service
  sale-service:
    container_name: sale-service-container
    image: sale-service-image
    build:
      context: .
      dockerfile: sale-service/Dockerfile
    ports:
      - "${SALE_SERVICE_PORT}:${SALE_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${SALE_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_SALE}
      SPRING_DATASOURCE_USERNAME: ${POSTGRESQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRESQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT_POSTGRESQL}
    depends_on:
      - discovery-service
  authentication-service:
    container_name: authentication-service-container
    image: authentication-service-image
    build:
      context: .
      dockerfile: authentication-service/Dockerfile
    ports:
      - "${AUTHENTICATION_SERVICE_PORT}:${AUTHENTICATION_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${AUTHENTICATION_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_AUTHENTICATION}
      SPRING_DATASOURCE_USERNAME: ${POSTGRESQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRESQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT_POSTGRESQL}
    depends_on:
      - discovery-service
  customer-service:
    container_name: customer-service-container
    image: customer-service-image
    build:
      context: .
      dockerfile: customer-service/Dockerfile
    ports:
      - "${CUSTOMER_SERVICE_PORT}:${CUSTOMER_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${CUSTOMER_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_CUSTOMER}
      SPRING_DATASOURCE_USERNAME: ${POSTGRESQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRESQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT_POSTGRESQL}
    depends_on:
      - discovery-service
  payment-gateway-service:
    container_name: payment-gateway-service-container
    image: payment-gateway-service-image
    build:
      context: .
      dockerfile: payment-gateway-service/Dockerfile
    ports:
      - "${PAYMENT_SERVICE_PORT}:${PAYMENT_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${PAYMENT_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_PAYMENT}
      SPRING_DATASOURCE_USERNAME: ${POSTGRESQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRESQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT_POSTGRESQL}
    depends_on:
      - discovery-service
  product-service:
    container_name: product-service-container
    image: product-service-image
    build:
      context: .
      dockerfile: product-service/Dockerfile
    ports:
      - "${PRODUCT_SERVICE_PORT}:${PRODUCT_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${PRODUCT_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_PRODUCT}
      SPRING_DATASOURCE_USERNAME: ${POSTGRESQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRESQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT_POSTGRESQL}
    depends_on:
      - discovery-service
  report-service:
    container_name: report-service-container
    image: report-service-image
    build:
      context: .
      dockerfile: report-service/Dockerfile
    ports:
      - "${REPORT_SERVICE_PORT}:${REPORT_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${REPORT_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_REPORT}
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER_MAIN_DEV}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASS_MAIN_DEV}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: ${DIALECT}
    depends_on:
      - discovery-service

  api-gateway:
    container_name: api-gateway-container
    image: api-gateway-image
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    ports:
      - "${API_GATEWAY_SERVICE_PORT}:${API_GATEWAY_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${API_GATEWAY_SERVICE_PORT}
      DISCOVERY_SERVER_URL: ${DISCOVERY_SERVICE_EXTERNAL_URL}
    depends_on:
    # por cada microservicio cliente que se conecte a la API gateway, se debe agregar una dependencia
      - discovery-service
      - employee-service
      - inventory-matter-service
      - sale-service
      - authentication-service
      - customer-service
      - payment-gateway-service
      - product-service
      - report-service

volumes:
  mysql_data:
  postgres_data:

